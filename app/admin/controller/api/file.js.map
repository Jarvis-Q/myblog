{
    "version": 3,
    "sources": [
        "../../../../src/admin/controller/api/file.js"
    ],
    "names": [
        "defaults",
        "strictSSL",
        "rejectUnauthorized",
        "getFileContent",
        "think",
        "promisify",
        "get",
        "writeFileAsync",
        "writeFile",
        "uploadConfig",
        "__before",
        "getUploadConfig",
        "postAction",
        "config",
        "type",
        "file",
        "post",
        "getUrlFile",
        "fail",
        "message",
        "serviceImport",
        "name",
        "serviceUpload",
        "path",
        "getAction",
        "PATH",
        "join",
        "RUNTIME_PATH",
        "model",
        "getCount",
        "num",
        "getLatest",
        "data",
        "zip",
        "item",
        "datetime",
        "generateNodeStream",
        "streamFiles",
        "pipe",
        "createWriteStream",
        "on",
        "download",
        "Error",
        "success",
        "getOptions",
        "options",
        "upload",
        "service",
        "uploader",
        "run",
        "result",
        "importor",
        "page",
        "category",
        "tag",
        "url",
        "headers",
        "timeout",
        "encoding",
        "catch",
        "resp",
        "indexOf",
        "uploadDir",
        "file_upload_path",
        "tmpdir",
        "isDir",
        "mkdir",
        "uploadName",
        "uuid",
        "extname",
        "uploadPath",
        "body",
        "fieldName",
        "originalFilename",
        "basename",
        "size"
    ],
    "mappings": "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",
    "file": "../../../../src/admin/controller/api/file.js",
    "sourcesContent": [
        "import os from 'os';\nimport fs from 'fs';\nimport path from 'path';\nimport { execSync } from 'child_process';\nimport request from 'request';\nimport JSZip from 'jszip';\n\nimport Base from './base';\n\nrequest.defaults({\n  strictSSL: false,\n  rejectUnauthorized: false\n});\n\nconst getFileContent = think.promisify(request.get, request);\nconst writeFileAsync = think.promisify(fs.writeFile, fs);\n\nexport default class extends Base {\n  uploadConfig = {};\n\n  async __before() {\n    this.uploadConfig = await this.getUploadConfig();\n  }\n\n  async postAction() {\n    let config = this.uploadConfig;\n    let {type} = config;\n    let file;\n\n    /** 处理远程抓取 **/\n    if(this.post('fileUrl')) {\n      try {\n        file = await this.getUrlFile(this.post('fileUrl'));\n      } catch(e) {\n        return this.fail(e.message);\n      }\n    } else {\n      file = this.file('file');\n    }\n    if(!file) { return this.fail('FILE_UPLOAD_ERROR'); }\n\n    /** 处理导入数据 **/\n    if(this.post('importor')) {\n      return this.serviceImport(this.post('importor'), file);\n    }\n\n    /** 检查文件类型 */\n    // let contentType = file.headers['content-type'];\n\n    // 处理其它上传\n    if(!type) { return this.fail(); }\n    if(type === 'local') {\n      config = {name: this.post('name')};\n    }\n\n    return this.serviceUpload(type, file.path, config);\n  }\n\n  // 导出 Markdown 文件\n  async getAction() {\n    const PATH = path.join(think.RUNTIME_PATH, 'exportedMarkdownFiles');\n\n    if (this.get('type') === 'markdown') {\n      let num = await this.model('post').getCount();\n      let data = await this.model('post').getLatest(0, num);\n      try {\n        execSync(`rm -rf ${PATH}; mkdir ${PATH};`);\n        let zip = new JSZip();\n        for (let item of data) {\n          zip.file(`${think.datetime(item['create_time'], 'YYYY-MM-DD-')}${item['title']}.md`, item['markdown_content']);\n        }\n\n        zip\n          .generateNodeStream({ type: 'nodebuffer', streamFiles: true })\n          .pipe(fs.createWriteStream(path.join(PATH, 'export.zip')))\n          .on('finish', () => this.download(path.join(PATH, 'export.zip')));\n      } catch (e) {\n        throw new Error(e);\n      }\n    } else {\n      this.success();\n    }\n  }\n\n  // 获取上传设置\n  async getUploadConfig() {\n    const options = await this.model('options').getOptions();\n    return options.upload;\n  }\n\n  /**\n   * 上传文件\n   */\n  async serviceUpload(service, file, config) {\n    try {\n      const uploader = think.service(`upload/${service}`, 'admin');\n      const result = await (new uploader()).run(file, config);\n      return this.success(result);\n    } catch (e) {\n      return this.fail(e || 'FILE_UPLOAD_ERROR');\n    }\n  }\n\n  /**\n   * 从其他平台导入数据\n   */\n  async serviceImport(service, file) {\n    try {\n      let importor = think.service(`import/${service}`, 'admin');\n      let {post, page, category, tag} = await (new importor(this)).run(file);\n      return this.success(`共导入文章 ${post} 篇，页面 ${page} 页，分类 ${category} 个，标签 ${tag} 个`);\n    } catch(e) {\n      return this.fail(e);\n    }\n  }\n\n  async getUrlFile(url) {\n    let resp = await getFileContent({\n      url,\n      headers: {\n        'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_2) Chrome/47.0.2526.111 Safari/537.36'\n      },\n      strictSSL: false,\n      timeout: 1000,\n      encoding: 'binary'\n    }).catch(() => { throw new Error('UPLOAD_URL_ERROR'); });\n\n    if(resp.headers['content-type'].indexOf('image') === -1) {\n      throw new Error('UPLOAD_TYPE_ERROR');\n    }\n\n    let uploadDir = this.config('post').file_upload_path;\n    if(!uploadDir) {\n      uploadDir = path.join(os.tmpdir(), 'thinkjs/upload');\n    }\n    if(!think.isDir(uploadDir)) {\n      think.mkdir(uploadDir);\n    }\n\n    let uploadName = think.uuid(20) + path.extname(url);\n    let uploadPath = path.join(uploadDir, uploadName);\n    await writeFileAsync(uploadPath, resp.body, 'binary');\n\n    return {\n      fieldName: 'file',\n      originalFilename: path.basename(url),\n      path: uploadPath,\n      size: resp.headers['content-length']\n    };\n  }\n}\n"
    ]
}